name: CI/CD

on:
    push:
        branches: [main]
    pull_request:
        branches: [main]
    workflow_dispatch: # å…è®¸æ‰‹åŠ¨è§¦å‘

# è®¾ç½®çŽ¯å¢ƒå˜é‡
env:
    NODE_VERSION: '18.x'

jobs:
    # ä»£ç è´¨é‡æ£€æŸ¥
    lint:
        name: Code Quality Check
        runs-on: ubuntu-latest
        timeout-minutes: 10

        steps:
            - name: Checkout repository
              uses: actions/checkout@v4

            - name: Setup Node.js ${{ env.NODE_VERSION }}
              uses: actions/setup-node@v4
              with:
                  node-version: ${{ env.NODE_VERSION }}
                  cache: 'npm'

            - name: Install dependencies
              run: npm ci

            - name: Check code formatting
              run: npm run format:check

            - name: TypeScript type check
              run: npm run type-check

    # æž„å»ºé¡¹ç›®
    build:
        name: Build Project
        runs-on: ubuntu-latest
        needs: lint # ç­‰å¾… lint é€šè¿‡åŽæ‰æ‰§è¡Œ
        timeout-minutes: 15

        strategy:
            matrix:
                node-version: [18.x]

        steps:
            - name: Checkout repository
              uses: actions/checkout@v4

            - name: Setup Node.js ${{ matrix.node-version }}
              uses: actions/setup-node@v4
              with:
                  node-version: ${{ matrix.node-version }}
                  cache: 'npm'

            - name: Install dependencies
              run: npm ci

            - name: Build project
              run: npm run build
              env:
                  NODE_ENV: production

            - name: Check build artifacts
              run: |
                  if [ ! -d "dist" ]; then
                      echo "âŒ Build failed: dist directory not found"
                      exit 1
                  fi
                  echo "âœ… Build artifacts:"
                  ls -lh dist/ || true

            - name: Upload build artifacts
              if: success()
              uses: actions/upload-artifact@v4
              with:
                  name: dist-${{ github.sha }}
                  path: dist/
                  retention-days: 7
                  compression-level: 6

            - name: Upload build summary
              if: success()
              run: |
                  echo "## ðŸ“¦ Build Summary" >> $GITHUB_STEP_SUMMARY
                  echo "" >> $GITHUB_STEP_SUMMARY
                  echo "- **Commit**: ${{ github.sha }}" >> $GITHUB_STEP_SUMMARY
                  echo "- **Branch**: ${{ github.ref_name }}" >> $GITHUB_STEP_SUMMARY
                  echo "- **Node Version**: ${{ matrix.node-version }}" >> $GITHUB_STEP_SUMMARY
                  echo "- **Build Time**: $(date -u +'%Y-%m-%d %H:%M:%S UTC')" >> $GITHUB_STEP_SUMMARY
                  echo "" >> $GITHUB_STEP_SUMMARY
                  echo "### Build Artifacts" >> $GITHUB_STEP_SUMMARY
                  echo "\`\`\`" >> $GITHUB_STEP_SUMMARY
                  ls -lh dist/ >> $GITHUB_STEP_SUMMARY || echo "No artifacts found" >> $GITHUB_STEP_SUMMARY
                  echo "\`\`\`" >> $GITHUB_STEP_SUMMARY

    # éƒ¨ç½²åˆ° GitHub Pages
    deploy:
        name: Deploy to GitHub Pages
        needs: build
        runs-on: ubuntu-latest
        if: github.ref == 'refs/heads/main' && github.event_name == 'push'
        timeout-minutes: 10

        # Grant GITHUB_TOKEN the permissions required to make a Pages deployment
        permissions:
            pages: write # to deploy to Pages
            id-token: write # to verify the deployment originates from an appropriate source

        # Deploy to the github-pages environment
        environment:
            name: github-pages
            url: ${{ steps.deployment.outputs.page_url }}

        steps:
            - name: Download artifact
              uses: actions/download-artifact@v4
              with:
                  name: dist-${{ github.sha }}
                  path: dist

            - name: Setup Pages
              uses: actions/configure-pages@v4

            - name: Upload artifact for Pages
              uses: actions/upload-pages-artifact@v3
              with:
                  path: dist

            - name: Deploy to GitHub Pages
              id: deployment
              uses: actions/deploy-pages@v4

            - name: Deployment summary
              if: success()
              run: |
                  echo "## ðŸš€ Deployment Summary" >> $GITHUB_STEP_SUMMARY
                  echo "" >> $GITHUB_STEP_SUMMARY
                  echo "âœ… Successfully deployed to GitHub Pages!" >> $GITHUB_STEP_SUMMARY
                  echo "" >> $GITHUB_STEP_SUMMARY
                  echo "- **URL**: ${{ steps.deployment.outputs.page_url }}" >> $GITHUB_STEP_SUMMARY
                  echo "- **Deployment Time**: $(date -u +'%Y-%m-%d %H:%M:%S UTC')" >> $GITHUB_STEP_SUMMARY
